USE WAREHOUSE FSDA;

------------------1: ROAD SAFETY IN UK ------------------------
CREATE DATABASE SAFETY_POPULATION;
USE SAFETY_POPULATION;
--------CREATE  TABLES-----------

CREATE TABLE RR_ACCIDENTS
        (
            ACCIDENT_INDEX VARCHAR(14),
            ACCIDENT_SEVERITY INT
        );
        
CREATE TABLE RR_VEHICLES
        (
            ACCIDENT_INDEX VARCHAR(14),
            VEHICLE_TYPE VARCHAR(50)
        );
        
CREATE TABLE RR_VEHICLE_TYPES
        (
            VEHICLE_CODE INT,
            VEHICLE_TYPE VARCHAR(50)
        );
        
-----------LOAD THE DATA RECORDS IN THE TABLES-----------------
LOAD DATA LOCAL INFILE 'D:/iNeuron/Assignments/Sql/Assignment2/Accidents2015.csv'
INTO TABLE RR_ACCIDENTS
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 LINES

------------------WE ARE LOADING ONLY TWO COLUMNS FROM CSV FILE ACCIDENTS2015-----------------------------

(@col1, @dummy, @dummy, @dummy, @dummy, @dummy, @col2, @dummy,
 @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy,
 @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy,
 @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy)
 
SET ACCIDENT_INDEX=@col1, ACCIDENT_SEVERITY=@col2;

SHOW GLOBAL VARIABLES LIKE 'local_infile';
set global local_infile=1;

LOAD DATA LOCAL INFILE 'D:/iNeuron/Assignments/Sql/Assignment2/Accidents2015.csv'
INTO TABLE RR_VEHICLES
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 LINES

(@col1, @dummy, @col2, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy, @dummy)

SET ACCIDENT_INDEX=@col1, VEHICLE_TYPE=@col2;

LOAD DATA LOCAL INFILE 'D:/iNeuron/Assignments/Sql/Assignment2/Accidents2015.csv'
INTO TABLE RR_VEHICLE_TYPES
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 LINES;

---------SHOW ALL TABLES IN DATABASE-----------------
SHOW TABLES;
SELECT * FROM RR_ACCIDENTS;
SELECT * FROM RR_VEHICLES;
SELECT * FROM RR_VEHICLE_TYPES;

---------EVALUATE THE MEDIAN SEVERITY VALUE OF ACCIDENTS CAUSED BY VARIOUS MOTORCYCLES-------------

WITH All_Data AS (SELECT ACCIDENT_SEVERITY FROM RR_ACCIDENTS A
                 JOIN RR_VEHICLES V ON A.ACCIDENT_INDEX=V.ACCIDENT_INDEX
                 JOIN RR_VEHICLE_TYPES T ON V.VEHICLE_TYPE=T.VEHICLE_CODE),
All_Data_rank AS (SELECT ACCIDENT_SEVERITY, DENSE_RANK() OVER(ORDER BY ACCIDENT_SEVERITY ASC) AS ASC_ACCIDENT_SEVERITY,
                  DENSE_RANK() OVER(ORDER BY ACCIDENT_SEVERITY DESC) AS DESC_ACCIDENT_SEVERITY,
                  FROM All_Data)
SELECT AVG(SCCIDENT_SEVERITY) FROM All_Data_rank
WHERE ASC_ACCIDENT_SEVERITY IN (DESC_ACCIDENT_SEVERITY,DESC_ACCIDENT_SEVERITY + 1,DESC_ACCIDENT_SEVERITY - 1);

---------EVALUATE THE ACCIDENT_SEVERITY AND TOTAL ACCIDENTS PER VEHICLE_TYPE--------------
SELECT ACCIDENT_SEVERITY,T.VEHICLE_TYPES AS VEHICLE_TYPE, COUNT(T.VEHICLE_TYPES) NO_OF_ACCIDENT FROM RR_ACCIDENTS A
JOIN RR_VEHICLES AS V ON A.ACCIDENT_INDEX=V.ACCIDENT_INDEX
JOIN RR_VEHICLE_TYPES AS T ON V.VEHICLE_TYPES=T.VEHICLE_CODE
GROUP BY 1,2;

--------CALCULATE AVERAGE SEVERITY BY VEHICLE TYPE----------
SELECT T.VEHICLE_TYPE AS VEHICLE_TYPE, AVG(ACCIDENT_SEVERITY) AS AVERAGE_SEVERITY FROM RR_ACCIDENT AS A
JOIN RR_VEHICLES V ON A.ACCIDENT_INDEX=V.ACCIDENT_INDEX
JOIN RR_VEHICLE_TYPES T ON V.VEHICLE_TYPE=T.VEHICLE_CODE
GROUP BY T.VEHICLE_TYPE;

--------CALCULATE AVERAGE SECURITY AND TOTAL ACCIDENTS BY MOTORCYCLE------------
SELECT T.VEHICLE_TYPE AS VEHICLE_TYPE,AVG(ACCIDENT_SEVERITY) AS AVERAGE_SECURITY,
COUNT(T.VEHICLE_TYPE) AS TOTAL_ACCIDENTS FROM RR_ACCIDENTS A
JOIN RR_VEHICLES V ON A.ACCIDENT_INDEX=V.ACCIDENT_INDEX
JOIN RR_VEHICLE_TYPES AS T ON V.VEHICLE_TYPE=T.VEHICLE_CODE
WHERE lower(T.VEHICLE_TYPES) LIKE '%motorcycle%'
GROUP BY VEHICLE_TYPE;




---------------------------2: WORLD POPULATION--------------------
USE WAREHOUSE FSDA;
CREATE DATABASE POPULATION;
USE POPULATION;
-----CREATE TABLES-------
CREATE TABLE RR_COUNTRY_POPULATION
        (
            COUNTRY_CODE VARCHAR(40) NOT NULL,
            COUNTRY_NAME VARCHAR(40) NOT NULL,
            DATE_YEAR INT NOT NULL,
            RACE_CODE INT NOT NULL,
            RACE TEXT NOT NULL,
            GENDER VARCHAR(6) NOT NULL,
            AGE INT NOT NULL,
            POPULATION INT NOT NULL
        );
--------LOAD THE DATA INTO THE TABLE--------------
--------IGNORE THE FIRST HEADER LINE, DELIMITER SETTING,---------
LOAD DATA LOCAL INFILE 'D:/iNeuron/Assignment/Sql/Assignment2/CA_DRU_proj_2010-2060.csv'
INTO TABLE RR_COUNTRY_POPULATION
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 LINES;

---------CHECK THE LOADED DATA---------
SELECT * FROM RR_COUNTRY_POPULATION
LIMIT 10;

---------Q: WHICH COUNTRY HAS THE HIGHEST POPULATION--------
SELECT COUNTRY_NAME,SUM(POPULATION) AS TOTAL_POPULATION FROM RR_COUNTRY_POPULATION
GROUP BY COUNTRY_NAME
ORDER BY TOTAL_POPULATION DESC
LIMIT 1;
---------Q: WHICH COUNTRY HAS THE LEAST NUMBER OF PEOPLE---------
SELECT COUNTRY_NAME,SUM(POPULATION) AS TOTAL_POPULATION FROM RR_COUNTRY_POPULATION
GROUP BY COUNTRY_NAME
ORDER BY TOTAL_POPUALTION ASC
LIMIT 1;
---------Q: WHICH COUNTRY IS WITNESSING HIGHEST POPULATION GROWTH--------
SELECT COUNTRY_POP AS (SELECT COUNTRY_NAME,DATE_YEAR,SUM(POPULATION) AS POP_BY_YEAR FROM RR_COUNTRY_POPULATION
                      GROUP BY 1,2),
       GROWTH_POP AS (SELECT COUNTRY_NAME,DATE_YEAR,POP_BY_YEAR,
                     LEAD(POP_BY_YEAR) OVER(PARTITION BY COUNTRY_NAME ORDER BY DATE_YEAR) NEXT_YR_POP FROM COUNTRY_POP)
                     SELECT COUNTRY_NAME,DATE_YEAR,POP_BY_YEAR,ROUND(((NEXT_YR_POP-POP_BY_YEAR)/POP_BY_YEAR * 100),2) AS POP_GROWTH_PERCENT
                     FROM GROWTH_POP
                     ORDER BY POP_GROWTH_PERCENT DESC
                     LIMIT 1;
                      
---------Q: WHICH COUNTRY HAS THE EXTRAORDINARY NUMBER FOR POPULATION--------
SELECT COUNTRY_NAME,SUM(POPULATION) AS TOTAL_POPULATION FROM RR_COUNTRY_POPULATION
GROUP BY COUNTRY_NAME
ORDER BY TOTAL_POPULATION DESC
LIMIT 10;
---------Q: WHICH COUNTRY IS THE MOST DENSELY POPULATED COUNTRY IN THE WORLD-----------
---AREA OF THE COUNTRIES ARE NOT GIVEN IN DATASET AND WE CANNOT CALCULATE THE POPULATION DENSITY OF A COUNTRY---
---CONCEPT---
--POPULATION_DENSITY=(NO_OF_PEOPLE/LAND_AREA).
